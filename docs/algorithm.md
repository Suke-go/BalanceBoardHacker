# アルゴリズム詳細 - Adaptive Multi-Harmonic Interference Cancellation (AMHIC)

## 1. 問題設定

観測信号:
```
y[n] = s[n] + d[n] + w[n]
```

- `s[n]`: 姿勢動揺信号（目標、0-6Hz）
- `d[n]`: 振動干渉（除去対象、20-80Hz）
- `w[n]`: センサノイズ

## 2. 適応フィルタ構造

### 2.1 参照信号生成

振動出力の位相 `φ[n]` を用いて、マルチハーモニクス参照ベクトルを生成:

```
r[n] = [sin(φ[n]), cos(φ[n]),
        sin(2φ[n]), cos(2φ[n]),
        sin(3φ[n]), cos(3φ[n])]ᵀ
```

**根拠**: 振動子（スピーカー/アクチュエータ）は非線形性を持ち、高調波歪みが発生する。

### 2.2 干渉推定

適応重み `w` を用いて干渉を推定:

```
d̂[n] = wᵀ[n] · r[n]
```

### 2.3 誤差信号

```
e[n] = y[n] - d̂[n]
```

## 3. NLMS更新則

標準LMSの問題: 収束速度が入力パワーに依存

**NLMS (Normalized LMS)**:
```
w[n+1] = w[n] + μ · e[n] · r[n] / (‖r[n]‖² + ε)
```

- `μ`: ステップサイズ (0 < μ < 2)
- `ε`: 正則化項 (1e-6)

### パラメータ選択

| パラメータ | 値 | 理由 |
|------------|-----|------|
| μ | 0.1 | 安定性と収束速度のバランス |
| ε | 1e-6 | ゼロ除算防止、計算安定性 |
| Harmonics | 3 | 3次高調波まで補正（経験的に十分） |

## 4. 収束判定

MSE（平均二乗誤差）の分散を監視:

```
converged = (Var(MSE) < threshold) && (Mean(MSE) < 1.0)
```

- ウィンドウサイズ: 60サンプル（~1秒）
- 閾値: 0.01

## 5. 品質指標

### SNR改善

```
SNR_improvement = 10 · log₁₀(P_input / P_error + ε) [dB]
```

- `P_input`: 入力信号パワー（指数移動平均）
- `P_error`: 誤差信号パワー

## 6. 実装上の工夫

### 6.1 位相同期

オーディオ出力の `CurrentPhase` を直接参照することで、処理遅延による位相ずれを最小化。

### 6.2 スタックアロケーション

参照信号ベクトルは `stackalloc` でヒープ割り当てを回避（GC負荷軽減）。

### 6.3 重み制限

発散防止のため、重みを `[-100, 100]` にクランプ。

## 7. 比較: 他手法との違い

| 手法 | 利点 | 欠点 |
|------|------|------|
| ローパスフィルタ | 単純、遅延一定 | 振動帯域の情報損失 |
| ノッチフィルタ | 特定周波数除去 | 周波数固定、高調波非対応 |
| 標準LMS | 適応的 | 入力依存の収束速度 |
| **NLMS (本手法)** | 安定収束、多周波数 | 計算コストやや高 |

## 8. 参考文献

1. Haykin, S. (2002). *Adaptive Filter Theory* (4th ed.). Prentice Hall.
2. Widrow, B., & Stearns, S. D. (1985). *Adaptive Signal Processing*. Prentice-Hall.
3. Diniz, P. S. R. (2013). *Adaptive Filtering: Algorithms and Practical Implementation* (4th ed.). Springer.
